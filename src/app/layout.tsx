import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ko">
      <head>
        {/* ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒ ë°©ì§€ */}
        <meta name="csp" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; object-src 'none';" />
      </head>
      <body className={geistSans.className}>
        {children}
        {/* ê¸€ë¡œë²Œ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ë° í™•ì¥ í”„ë¡œê·¸ë¨ ì¶©ëŒ ë°©ì§€ */}
        <script 
          dangerouslySetInnerHTML={{
            __html: `
              // ê¸€ë¡œë²Œ ì—ëŸ¬ í•¸ë“¤ëŸ¬
              window.addEventListener('error', function(event) {
                console.error('ğŸš¨ ì „ì—­ ì—ëŸ¬ ë°œìƒ:', {
                  message: event.message,
                  filename: event.filename,
                  lineno: event.lineno,
                  colno: event.colno,
                  error: event.error
                });
                
                // í™•ì¥ í”„ë¡œê·¸ë¨ ê´€ë ¨ ì—ëŸ¬ëŠ” ë¬´ì‹œ
                if (event.filename && (
                  event.filename.includes('extension://') ||
                  event.filename.includes('chrome-extension://') ||
                  event.filename.includes('moz-extension://') ||
                  event.filename.includes('content.js') ||
                  event.filename.includes('script.js') ||
                  event.filename.includes('rl-cs.js')
                )) {
                  console.log('âš ï¸ ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ ì—ëŸ¬ ë¬´ì‹œë¨');
                  event.preventDefault();
                  return;
                }
                
                // ëª¨ë°”ì¼ì—ì„œ ì—ëŸ¬ í‘œì‹œ
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                  const errorDiv = document.createElement('div');
                  errorDiv.style.cssText = 'position:fixed;bottom:10px;left:10px;right:10px;background:red;color:white;padding:10px;border-radius:5px;z-index:9999;font-size:12px;';
                  errorDiv.innerHTML = 'âš ï¸ ì—ëŸ¬: ' + event.message + '<br>ìœ„ì¹˜: ' + (event.filename || 'unknown');
                  errorDiv.onclick = function() { this.remove(); };
                  document.body.appendChild(errorDiv);
                  setTimeout(() => errorDiv.remove(), 10000);
                }
              });
              
              // Promise rejection í•¸ë“¤ëŸ¬
              window.addEventListener('unhandledrejection', function(event) {
                console.error('ğŸš¨ ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', event.reason);
                
                // í™•ì¥ í”„ë¡œê·¸ë¨ ê´€ë ¨ ê±°ë¶€ëŠ” ë¬´ì‹œ
                if (event.reason && event.reason.stack && (
                  event.reason.stack.includes('extension://') ||
                  event.reason.stack.includes('chrome-extension://')
                )) {
                  console.log('âš ï¸ ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ Promise ê±°ë¶€ ë¬´ì‹œë¨');
                  event.preventDefault();
                  return;
                }
              });
              
              // Array.prototype.map ë³´í˜¸
              if (Array.prototype.map && !Array.prototype._originalMap) {
                Array.prototype._originalMap = Array.prototype.map;
                Array.prototype.map = function(...args) {
                  if (!this || typeof this !== 'object') {
                    console.error('ğŸš¨ map í˜¸ì¶œ ì˜¤ë¥˜: ëŒ€ìƒì´ ë°°ì—´ì´ ì•„ë‹˜', this);
                    return [];
                  }
                  try {
                    return Array.prototype._originalMap.apply(this, args);
                  } catch (e) {
                    console.error('ğŸš¨ map ì‹¤í–‰ ì˜¤ë¥˜:', e);
                    return [];
                  }
                };
              }
              
              console.log('âœ… ì—ëŸ¬ í•¸ë“¤ëŸ¬ ë° ë³´í˜¸ ì½”ë“œ ì„¤ì¹˜ ì™„ë£Œ');
            `
          }}
        />
        {/* ê°œë°œ í™˜ê²½ì—ì„œë§Œ ëª¨ë°”ì¼ ì½˜ì†” í™œì„±í™” */}
        {process.env.NODE_ENV === 'development' && (
          <script 
            dangerouslySetInnerHTML={{
              __html: `
                // ëª¨ë°”ì¼ì—ì„œë§Œ Eruda ì½˜ì†” ë¡œë“œ
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                  const script = document.createElement('script');
                  script.src = 'https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js';
                  script.onload = function() {
                    eruda.init();
                    console.log('ğŸ“± ëª¨ë°”ì¼ ë””ë²„ê·¸ ì½˜ì†”ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìš°í•˜ë‹¨ ë²„íŠ¼ì„ í„°ì¹˜í•˜ì„¸ìš”.');
                  };
                  document.head.appendChild(script);
                }
              `
            }}
          />
        )}
      </body>
    </html>
  )
}
