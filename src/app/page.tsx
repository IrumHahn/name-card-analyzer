'use client'

import { useState, useEffect, useRef } from 'react'
import { Camera, Upload, MessageCircle, Settings as SettingsIcon, Plus, Edit, Send, Trash2, Eye } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog'
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from '@/components/ui/alert-dialog'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import CameraCapture from '@/components/CameraCapture'
import SettingsDialog from '@/components/SettingsDialog'
import TemplateManagementDialog from '@/components/TemplateManagementDialog'

interface BusinessCard {
  id: string
  imagePath: string
  companyName?: string
  name?: string
  email?: string
  phone?: string
  address?: string
  notes?: string
  createdAt: string
  messageHistory?: Array<{
    id: string
    message: string
    status: string
    createdAt: string
  }>
}

interface MessageTemplate {
  id: string
  name: string
  content: string
  createdAt: string
}

interface Settings {
  id: string
  autoSendEnabled: boolean
  autoSendTemplateId?: string
  defaultSenderPhone?: string
}

interface UserProfile {
  id: string
  name?: string
  companyName?: string
  email?: string
  phone?: string
  address?: string
  title?: string
}

export default function Home() {
  const [businessCards, setBusinessCards] = useState<BusinessCard[]>([])
  const [templates, setTemplates] = useState<MessageTemplate[]>([])
  const [settings, setSettings] = useState<Settings | null>(null)
  const [userProfile, setUserProfile] = useState<UserProfile | null>(null)
  const [selectedCard, setSelectedCard] = useState<BusinessCard | null>(null)
  const [editingCard, setEditingCard] = useState<BusinessCard | null>(null)
  const [isUploading, setIsUploading] = useState(false)
  const [isSending, setIsSending] = useState(false)
  const [showCameraDialog, setShowCameraDialog] = useState(false)
  const [showTemplateDialog, setShowTemplateDialog] = useState(false)
  const [showSettingsDialog, setShowSettingsDialog] = useState(false)
  const [showSendDialog, setShowSendDialog] = useState(false)
  const [smsMessage, setSmsMessage] = useState('')
  const [selectedTemplate, setSelectedTemplate] = useState('')
  const [messageType, setMessageType] = useState<'custom' | 'template' | 'ai'>('custom')
  const [captureMode, setCaptureMode] = useState<'file' | 'camera'>('file')
  const [isDragging, setIsDragging] = useState(false)
  const [messagePreview, setMessagePreview] = useState('')
  const [debugInfo, setDebugInfo] = useState<any>(null)
  const [showDebugInfo, setShowDebugInfo] = useState(false)
  
  // ÌååÏùº ÏûÖÎ†• Ï∞∏Ï°∞
  const fileInputRef = useRef<HTMLInputElement>(null)

  // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    fetchBusinessCards()
    fetchTemplates()
    fetchSettings()
    fetchUserProfile()
  }, [])

  // Î©îÏãúÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
  useEffect(() => {
    updateMessagePreview()
  }, [messageType, selectedTemplate, smsMessage, selectedCard, templates, userProfile])

  const fetchBusinessCards = async () => {
    try {
      const response = await fetch('/api/business-cards')
      
      if (!response.ok) {
        console.error('API ÏùëÎãµ ÏóêÎü¨:', response.status, response.statusText)
        setBusinessCards([]) // ÏóêÎü¨ Ïãú Îπà Î∞∞Ïó¥Î°ú ÏÑ§Ï†ï
        return
      }
      
      const data = await response.json()
      
      // Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞∞Ïó¥Ïù∏ÏßÄ ÌôïÏù∏
      if (Array.isArray(data)) {
        setBusinessCards(data)
      } else {
        console.error('API ÏùëÎãµÏù¥ Î∞∞Ïó¥Ïù¥ ÏïÑÎãôÎãàÎã§:', data)
        setBusinessCards([])
      }
    } catch (error) {
      console.error('Î™ÖÌï® Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error)
      setBusinessCards([]) // ÏóêÎü¨ Ïãú Îπà Î∞∞Ïó¥Î°ú ÏÑ§Ï†ï
    }
  }

  const fetchTemplates = async () => {
    try {
      const response = await fetch('/api/message-templates')
      
      if (!response.ok) {
        console.error('API ÏùëÎãµ ÏóêÎü¨:', response.status, response.statusText)
        setTemplates([]) // ÏóêÎü¨ Ïãú Îπà Î∞∞Ïó¥Î°ú ÏÑ§Ï†ï
        return
      }
      
      const data = await response.json()
      
      // Îç∞Ïù¥ÌÑ∞Í∞Ä Î∞∞Ïó¥Ïù∏ÏßÄ ÌôïÏù∏
      if (Array.isArray(data)) {
        setTemplates(data)
      } else {
        console.error('API ÏùëÎãµÏù¥ Î∞∞Ïó¥Ïù¥ ÏïÑÎãôÎãàÎã§:', data)
        setTemplates([])
      }
    } catch (error) {
      console.error('ÌÖúÌîåÎ¶ø Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error)
      setTemplates([]) // ÏóêÎü¨ Ïãú Îπà Î∞∞Ïó¥Î°ú ÏÑ§Ï†ï
    }
  }

  const fetchSettings = async () => {
    try {
      const response = await fetch('/api/settings')
      
      if (!response.ok) {
        console.error('API ÏùëÎãµ ÏóêÎü¨:', response.status, response.statusText)
        setSettings(null) // ÏóêÎü¨ Ïãú nullÎ°ú ÏÑ§Ï†ï
        return
      }
      
      const data = await response.json()
      setSettings(data)
    } catch (error) {
      console.error('ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', error)
      setSettings(null) // ÏóêÎü¨ Ïãú nullÎ°ú ÏÑ§Ï†ï
    }
  }

  const fetchUserProfile = async () => {
    try {
      const response = await fetch('/api/user-profile')
      
      if (!response.ok) {
        console.error('API ÏùëÎãµ ÏóêÎü¨:', response.status, response.statusText)
        setUserProfile(null) // ÏóêÎü¨ Ïãú nullÎ°ú ÏÑ§Ï†ï
        return
      }
      
      const data = await response.json()
      setUserProfile(data)
    } catch (error) {
      console.error('ÌîÑÎ°úÌïÑ Î°úÎìú Ïã§Ìå®:', error)
      setUserProfile(null) // ÏóêÎü¨ Ïãú nullÎ°ú ÏÑ§Ï†ï
    }
  }

  // Î©îÏãúÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
  const updateMessagePreview = async () => {
    if (!selectedCard) return

    let preview = ''
    
    if (messageType === 'custom') {
      preview = smsMessage
    } else if (messageType === 'template' && selectedTemplate) {
      const template = templates.find(t => t.id === selectedTemplate)
      preview = template?.content || ''
    } else if (messageType === 'ai') {
      // AI Î©îÏãúÏßÄ ÏÉùÏÑ± ÎØ∏Î¶¨Î≥¥Í∏∞
      if (userProfile && selectedCard) {
        const profileInfo = [
          userProfile.name && `Ïù¥Î¶Ñ: ${userProfile.name}`,
          userProfile.title && `ÏßÅÏ±Ö: ${userProfile.title}`,
          userProfile.companyName && `ÌöåÏÇ¨: ${userProfile.companyName}`,
          userProfile.email && `Ïù¥Î©îÏùº: ${userProfile.email}`,
          userProfile.phone && `Ïó∞ÎùΩÏ≤ò: ${userProfile.phone}`,
        ].filter(Boolean).join('\n')
        
        preview = `ÏïàÎÖïÌïòÏÑ∏Ïöî! ${selectedCard.name || 'Í≥†Í∞ù'}ÎãòÍªò Ï†ú Î™ÖÌï®ÏùÑ Ï†ÑÌï¥ÎìúÎ¶ΩÎãàÎã§.\n\n${profileInfo}\n\nÏïûÏúºÎ°ú Ï¢ãÏùÄ Í¥ÄÍ≥Ñ Ïú†ÏßÄÌñàÏúºÎ©¥ Ï¢ãÍ≤†ÏäµÎãàÎã§. Í∞êÏÇ¨Ìï©ÎãàÎã§!`
      }
    }
    
    setMessagePreview(preview)
  }



  // Ïπ¥Î©îÎùº Ï¥¨ÏòÅ Ï≤òÎ¶¨
  const handleCameraCapture = async (imageBlob: Blob) => {
    console.log('üì§ Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ° ÏãúÏûë...', {
      blobSize: imageBlob.size,
      blobType: imageBlob.type,
      currentURL: window.location.href
    })
    
    setIsUploading(true)
    try {
      const formData = new FormData()
      formData.append('image', imageBlob, 'business-card.jpg')

      // ÌòÑÏû¨ Ìò∏Ïä§Ìä∏ Ï†ïÎ≥¥Î•º Í∏∞Î∞òÏúºÎ°ú Ï†àÎåÄ URL ÏÉùÏÑ±
      const apiUrl = `${window.location.origin}/api/business-cards`
      console.log('üöÄ API Ìò∏Ï∂ú URL:', apiUrl)

      const response = await fetch(apiUrl, {
        method: 'POST',
        body: formData,
      })

      console.log('üì° Ïπ¥Î©îÎùº Ï∫°Ï≤ò API ÏùëÎãµ ÏÉÅÌÉú:', {
        status: response.status,
        statusText: response.statusText,
        ok: response.ok,
        url: response.url
      })

      if (response.ok) {
        const newCard = await response.json()
        console.log('‚úÖ Ïπ¥Î©îÎùº Ï∫°Ï≤ò Î™ÖÌï® Îì±Î°ù ÏÑ±Í≥µ:', newCard)
        fetchBusinessCards()
        setShowCameraDialog(false)
        
        // ÏûêÎèôÎ∞úÏÜ° Í≤∞Í≥º ÌëúÏãú
        if (newCard.autoSend) {
          if (newCard.autoSend.success) {
            alert(`Î™ÖÌï®Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!\n\nÏûêÎèôÎ∞úÏÜ°ÎèÑ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.\nÌÖúÌîåÎ¶ø: ${newCard.autoSend.template}`)
          } else {
            alert(`Î™ÖÌï®Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!\n\nÏûêÎèôÎ∞úÏÜ° Ïã§Ìå®: ${newCard.autoSend.error}`)
          }
        } else {
          alert('Î™ÖÌï®Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!')
        }
      } else {
        console.error('‚ùå Ïπ¥Î©îÎùº Ï∫°Ï≤ò API Ïò§Î•ò ÏùëÎãµ:', {
          status: response.status,
          statusText: response.statusText,
          url: response.url
        })
        
        try {
          const errorData = await response.json()
          console.error('‚ùå Ïπ¥Î©îÎùº Ï∫°Ï≤ò ÏóêÎü¨ ÏÑ∏Î∂Ä Ï†ïÎ≥¥:', errorData)
          alert(`Î™ÖÌï® ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${errorData.error}`)
        } catch (parseError) {
          console.error('‚ùå Ïπ¥Î©îÎùº Ï∫°Ï≤ò ÏóêÎü¨ ÏùëÎãµ ÌååÏã± Ïã§Ìå®:', parseError)
          const errorText = await response.text()
          console.error('‚ùå Ïπ¥Î©îÎùº Ï∫°Ï≤ò ÏóêÎü¨ ÏùëÎãµ ÌÖçÏä§Ìä∏:', errorText)
          alert(`Î™ÖÌï® ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ (ÏÉÅÌÉú ÏΩîÎìú: ${response.status})`)
        }
      }
    } catch (error) {
      console.error('‚ùå Ïπ¥Î©îÎùº Ï∫°Ï≤ò ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò:', error)
      alert('Î™ÖÌï® ÏóÖÎ°úÎìú Ï§ë ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    } finally {
      setIsUploading(false)
    }
  }

  // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
  const handleFileUpload = async (file: File) => {
    if (!file.type.startsWith('image/')) {
      alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.')
      return
    }

    console.log('üìÅ ÌååÏùº ÏóÖÎ°úÎìú ÏãúÏûë...', {
      fileName: file.name,
      fileSize: file.size,
      fileType: file.type,
      currentURL: window.location.href
    })

    setIsUploading(true)
    try {
      const formData = new FormData()
      formData.append('image', file)

      // ÌòÑÏû¨ Ìò∏Ïä§Ìä∏ Ï†ïÎ≥¥Î•º Í∏∞Î∞òÏúºÎ°ú Ï†àÎåÄ URL ÏÉùÏÑ±
      const apiUrl = `${window.location.origin}/api/business-cards`
      console.log('üöÄ API Ìò∏Ï∂ú URL:', apiUrl)

      const response = await fetch(apiUrl, {
        method: 'POST',
        body: formData,
      })

      if (response.ok) {
        const newCard = await response.json()
        fetchBusinessCards()
        setShowCameraDialog(false)
        
        // ÏûêÎèôÎ∞úÏÜ° Í≤∞Í≥º ÌëúÏãú
        if (newCard.autoSend) {
          if (newCard.autoSend.success) {
            alert(`Î™ÖÌï®Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!\n\nÏûêÎèôÎ∞úÏÜ°ÎèÑ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.\nÌÖúÌîåÎ¶ø: ${newCard.autoSend.template}`)
          } else {
            alert(`Î™ÖÌï®Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!\n\nÏûêÎèôÎ∞úÏÜ° Ïã§Ìå®: ${newCard.autoSend.error}`)
          }
        } else {
          alert('Î™ÖÌï®Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!')
        }
      } else {
        const errorData = await response.json()
        alert(`Î™ÖÌï® ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${errorData.error}`)
      }
    } catch (error) {
      console.error('ÏóÖÎ°úÎìú Ïã§Ìå®:', error)
      alert('Î™ÖÌï® ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    } finally {
      setIsUploading(false)
    }
  }

  // ÌååÏùº ÏÑ†ÌÉù Í¥ÄÎ†® Ìï®ÏàòÎì§
  const handleFileSelectClick = () => {
    fileInputRef.current?.click()
  }

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFileUpload(file)
    }
  }

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault()
    setIsDragging(true)
  }

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault()
    setIsDragging(false)
  }

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    setIsDragging(false)

    const files = e.dataTransfer.files
    if (files.length > 0) {
      const file = files[0]
      handleFileUpload(file)
    }
  }

  // Îã§Ïù¥ÏñºÎ°úÍ∑∏ Í¥ÄÎ†® Ìï®ÏàòÎì§
  const handleOpenDialog = () => {
    setCaptureMode('file')
    setShowCameraDialog(true)
  }

  const handleCameraCancel = () => {
    setShowCameraDialog(false)
    setCaptureMode('file')
    setIsDragging(false)
  }

  // SMS Î∞úÏÜ°
  const sendSMS = async () => {
    if (!selectedCard) return

    setIsSending(true)
    try {
      const response = await fetch('/api/send-sms', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          businessCardId: selectedCard.id,
          message: messageType === 'custom' ? smsMessage : undefined,
          templateId: messageType === 'template' ? selectedTemplate : undefined,
          useAI: messageType === 'ai',
        }),
      })

      const result = await response.json()
      
      if (result.success) {
        alert('Î¨∏ÏûêÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§!')
        fetchBusinessCards()
        setShowSendDialog(false)
        setSmsMessage('')
        setSelectedTemplate('')
      } else {
        alert(`Î¨∏Ïûê Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${result.error}`)
      }
    } catch (error) {
      console.error('SMS Î∞úÏÜ° Ïã§Ìå®:', error)
      alert('Î¨∏Ïûê Î∞úÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    } finally {
      setIsSending(false)
    }
  }

  // Î™ÖÌï® Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
  const updateBusinessCard = async (id: string, updates: Partial<BusinessCard>) => {
    try {
      const response = await fetch(`/api/business-cards/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(updates),
      })

      if (response.ok) {
        fetchBusinessCards()
        setEditingCard(null)
        alert('Î™ÖÌï® Ï†ïÎ≥¥Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!')
      } else {
        alert('Î™ÖÌï® Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
      }
    } catch (error) {
      console.error('Î™ÖÌï® ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error)
      alert('Î™ÖÌï® ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    }
  }

  // Î™ÖÌï® ÏÇ≠Ï†ú
  const deleteBusinessCard = async (id: string) => {
    try {
      const response = await fetch(`/api/business-cards/${id}`, {
        method: 'DELETE',
      })

      if (response.ok) {
        fetchBusinessCards()
        alert('Î™ÖÌï®Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!')
      } else {
        alert('Î™ÖÌï® ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
      }
    } catch (error) {
      console.error('Î™ÖÌï® ÏÇ≠Ï†ú Ïã§Ìå®:', error)
      alert('Î™ÖÌï® ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.')
    }
  }

  // Î©îÏãúÏßÄ Î∞úÏÜ° Îã§Ïù¥ÏñºÎ°úÍ∑∏ Ïó¥Í∏∞
  const openSendDialog = (card: BusinessCard) => {
    setSelectedCard(card)
    setMessageType('custom')
    setSmsMessage('')
    setSelectedTemplate('')
    setShowSendDialog(true)
  }

  // ÏãúÏä§ÌÖú ÏßÑÎã®
  const runHealthCheck = async () => {
    try {
      const response = await fetch('/api/health')
      const data = await response.json()
      setDebugInfo(data)
      setShowDebugInfo(true)
    } catch (error) {
      setDebugInfo({
        status: 'error',
        message: error instanceof Error ? error.message : String(error),
        timestamp: new Date().toISOString()
      })
      setShowDebugInfo(true)
    }
  }

  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <div className="max-w-7xl mx-auto">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-3xl font-bold text-gray-900">Î™ÖÌï® Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h1>
          <div className="flex gap-2">
            <Dialog open={showCameraDialog} onOpenChange={setShowCameraDialog}>
              <DialogTrigger asChild>
                <Button onClick={handleOpenDialog} className="flex items-center gap-2">
                  <Plus className="w-4 h-4" />
                  Î™ÖÌï® Îì±Î°ù
                </Button>
              </DialogTrigger>
                          <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle>Î™ÖÌï® Îì±Î°ù</DialogTitle>
                <DialogDescription>
                  Ïπ¥Î©îÎùºÎ°ú Ï¥¨ÏòÅÌïòÍ±∞ÎÇò ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥ÏÑú Î™ÖÌï®ÏùÑ Îì±Î°ùÌïòÏÑ∏Ïöî.
                </DialogDescription>
              </DialogHeader>
                {isUploading ? (
                  <div className="flex flex-col items-center justify-center py-8 space-y-4">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    <span className="text-lg font-medium">Î™ÖÌï® Ï†ïÎ≥¥Î•º Ï∂îÏ∂úÌïòÎäî Ï§ë...</span>
                    <p className="text-sm text-gray-600">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {/* Î∞©Ïãù ÏÑ†ÌÉù Î≤ÑÌäº */}
                    <div className="flex space-x-2">
                      <Button
                        variant={captureMode === 'file' ? 'default' : 'outline'}
                        onClick={() => setCaptureMode('file')}
                        className="flex-1"
                      >
                        <Upload className="w-4 h-4 mr-2" />
                        ÌååÏùº ÏóÖÎ°úÎìú
                      </Button>
                      <Button
                        variant={captureMode === 'camera' ? 'default' : 'outline'}
                        onClick={() => setCaptureMode('camera')}
                        className="flex-1"
                      >
                        <Camera className="w-4 h-4 mr-2" />
                        Ïπ¥Î©îÎùº Ï¥¨ÏòÅ
                      </Button>
                    </div>

                    {/* ÌååÏùº ÏóÖÎ°úÎìú Î™®Îìú */}
                    {captureMode === 'file' && (
                      <div className="space-y-4">
                        <div 
                          className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${
                            isDragging 
                              ? 'border-blue-500 bg-blue-50' 
                              : 'border-gray-300 hover:border-gray-400'
                          }`}
                          onDragOver={handleDragOver}
                          onDragLeave={handleDragLeave}
                          onDrop={handleDrop}
                        >
                          <Upload className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                          <div className="space-y-2">
                            <p className="text-lg font-medium text-gray-700">
                              {isDragging ? 'ÌååÏùºÏùÑ Ïó¨Í∏∞Ïóê ÎìúÎ°≠ÌïòÏÑ∏Ïöî' : 'Î™ÖÌï® Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'}
                            </p>
                            <p className="text-sm text-gray-500">
                              ÌÅ¥Î¶≠ÌïòÏó¨ ÌååÏùº ÏÑ†ÌÉù ÎòêÎäî ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠
                            </p>
                            <p className="text-xs text-gray-400">
                              Î™®Î∞îÏùºÏóêÏÑúÎäî Ïπ¥Î©îÎùº Ïï±Ïù¥ ÏûêÎèôÏúºÎ°ú Ïã§ÌñâÎê©ÎãàÎã§
                            </p>
                          </div>
                          <Button 
                            onClick={handleFileSelectClick}
                            className="mt-4"
                            type="button"
                          >
                            ÌååÏùº ÏÑ†ÌÉù
                          </Button>
                        </div>
                        
                        {/* Ïà®Í≤®ÏßÑ ÌååÏùº ÏûÖÎ†• */}
                        <input
                          ref={fileInputRef}
                          type="file"
                          accept="image/*"
                          capture="environment"
                          onChange={handleFileChange}
                          className="hidden"
                        />
                        
                        <div className="flex justify-end">
                          <Button onClick={handleCameraCancel} variant="outline">
                            Ï∑®ÏÜå
                          </Button>
                        </div>
                      </div>
                    )}

                    {/* Ïπ¥Î©îÎùº Ï¥¨ÏòÅ Î™®Îìú */}
                    {captureMode === 'camera' && (
                      <CameraCapture 
                        onCapture={handleCameraCapture}
                        onCancel={handleCameraCancel}
                        debug={true}
                      />
                    )}
                  </div>
                )}
              </DialogContent>
            </Dialog>

            <Button 
              variant="outline"
              onClick={() => setShowTemplateDialog(true)}
            >
              <MessageCircle className="mr-2 h-4 w-4" />
              ÌÖúÌîåÎ¶ø Í¥ÄÎ¶¨
            </Button>
            
            <Button 
              variant="outline"
              onClick={() => setShowSettingsDialog(true)}
            >
              <SettingsIcon className="mr-2 h-4 w-4" />
              ÏÑ§Ï†ï
            </Button>
            
            <Button 
              variant="outline"
              onClick={runHealthCheck}
              className="text-xs"
            >
              üîß ÏãúÏä§ÌÖú ÏßÑÎã®
            </Button>
          </div>
        </div>

        {/* Î™ÖÌï® Î™©Î°ù */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {businessCards.map((card) => (
            <Card key={card.id} className="overflow-hidden">
              <CardHeader className="pb-3">
                <div className="flex justify-between items-start">
                  <div>
                    <CardTitle className="text-lg">{card.name || 'Ïù¥Î¶Ñ ÏóÜÏùå'}</CardTitle>
                    <p className="text-sm text-gray-600">{card.companyName || 'ÌöåÏÇ¨Î™Ö ÏóÜÏùå'}</p>
                  </div>
                  <div className="flex gap-1">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setEditingCard(card)}
                    >
                      <Edit className="h-4 w-4" />
                    </Button>
                    
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => openSendDialog(card)}
                      disabled={!card.phone}
                    >
                      <Send className="h-4 w-4" />
                    </Button>

                    <AlertDialog>
                      <AlertDialogTrigger asChild>
                        <Button variant="outline" size="sm">
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </AlertDialogTrigger>
                      <AlertDialogContent>
                        <AlertDialogHeader>
                          <AlertDialogTitle>Î™ÖÌï® ÏÇ≠Ï†ú</AlertDialogTitle>
                          <AlertDialogDescription>
                            "{card.name || 'Ïù¥Î¶Ñ ÏóÜÏùå'}" Î™ÖÌï®ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                            Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.
                          </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                          <AlertDialogCancel>Ï∑®ÏÜå</AlertDialogCancel>
                          <AlertDialogAction onClick={() => deleteBusinessCard(card.id)}>
                            ÏÇ≠Ï†ú
                          </AlertDialogAction>
                        </AlertDialogFooter>
                      </AlertDialogContent>
                    </AlertDialog>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  {card.email && (
                    <p className="text-sm text-gray-600">üìß {card.email}</p>
                  )}
                  {card.phone && (
                    <p className="text-sm text-gray-600">üìû {card.phone}</p>
                  )}
                  {card.address && (
                    <p className="text-sm text-gray-600">üìç {card.address}</p>
                  )}
                  {card.notes && (
                    <p className="text-sm text-gray-700 bg-gray-50 p-2 rounded">
                      üí≠ {card.notes}
                    </p>
                  )}
                  {card.messageHistory && card.messageHistory.length > 0 && (
                    <div className="mt-2">
                      <Badge variant="outline">
                        ÎßàÏßÄÎßâ Î∞úÏÜ°: {new Date(card.messageHistory[0].createdAt).toLocaleDateString()}
                      </Badge>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {businessCards.length === 0 && (
          <div className="text-center py-12">
            <Plus className="mx-auto h-12 w-12 text-gray-400 mb-4" />
            <h3 className="text-lg font-medium text-gray-900 mb-2">Î™ÖÌï®Ïù¥ ÏóÜÏäµÎãàÎã§</h3>
            <p className="text-gray-600">Ï≤´ Î™ÖÌï®ÏùÑ Îì±Î°ùÌï¥Î≥¥ÏÑ∏Ïöî!</p>
          </div>
        )}

        {/* Î™ÖÌï® ÏàòÏ†ï Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
        {editingCard && (
          <Dialog open={!!editingCard} onOpenChange={() => setEditingCard(null)}>
            <DialogContent>
              <DialogHeader>
                <DialogTitle>Î™ÖÌï® Ï†ïÎ≥¥ ÏàòÏ†ï</DialogTitle>
                <DialogDescription>
                  Î™ÖÌï®Ïùò Ï†ïÎ≥¥Î•º ÏàòÏ†ïÌïòÍ≥† Ï†ÄÏû•ÌïòÏÑ∏Ïöî.
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="edit-name">Ïù¥Î¶Ñ</Label>
                    <Input
                      id="edit-name"
                      value={editingCard.name || ''}
                      onChange={(e) => setEditingCard({ ...editingCard, name: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="edit-company">ÌöåÏÇ¨Î™Ö</Label>
                    <Input
                      id="edit-company"
                      value={editingCard.companyName || ''}
                      onChange={(e) => setEditingCard({ ...editingCard, companyName: e.target.value })}
                    />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="edit-email">Ïù¥Î©îÏùº</Label>
                    <Input
                      id="edit-email"
                      value={editingCard.email || ''}
                      onChange={(e) => setEditingCard({ ...editingCard, email: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="edit-phone">Ï†ÑÌôîÎ≤àÌò∏</Label>
                    <Input
                      id="edit-phone"
                      value={editingCard.phone || ''}
                      onChange={(e) => setEditingCard({ ...editingCard, phone: e.target.value })}
                    />
                  </div>
                </div>
                <div>
                  <Label htmlFor="edit-address">Ï£ºÏÜå</Label>
                  <Input
                    id="edit-address"
                    value={editingCard.address || ''}
                    onChange={(e) => setEditingCard({ ...editingCard, address: e.target.value })}
                  />
                </div>
                <div>
                  <Label htmlFor="edit-notes">Ï∂îÍ∞Ä Ï†ïÎ≥¥</Label>
                  <Textarea
                    id="edit-notes"
                    value={editingCard.notes || ''}
                    onChange={(e) => setEditingCard({ ...editingCard, notes: e.target.value })}
                    rows={3}
                    placeholder="ÎßåÎÇ¨Îçò ÎÇ¥Ïö©, ÌäπÏßï Îì±ÏùÑ Í∏∞Î°ùÌïòÏÑ∏Ïöî..."
                  />
                </div>
                <div className="flex gap-2">
                  <Button
                    onClick={() => updateBusinessCard(editingCard.id, editingCard)}
                    className="flex-1"
                  >
                    Ï†ÄÏû•
                  </Button>
                  <Button 
                    variant="outline" 
                    onClick={() => setEditingCard(null)}
                    className="flex-1"
                  >
                    Ï∑®ÏÜå
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>
        )}

        {/* Î¨∏Ïûê Î∞úÏÜ° Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
        {selectedCard && (
          <Dialog open={showSendDialog} onOpenChange={setShowSendDialog}>
            <DialogContent className="max-w-lg">
              <DialogHeader>
                <DialogTitle>Î¨∏Ïûê Î∞úÏÜ°</DialogTitle>
                <DialogDescription>
                  ÏÑ†ÌÉùÌïú Î™ÖÌï® ÏÜåÏú†ÏûêÏóêÍ≤å Î¨∏Ïûê Î©îÏãúÏßÄÎ•º Î∞úÏÜ°Ìï©ÎãàÎã§.
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4">
                <div className="text-sm text-gray-600">
                  <p>Î∞õÎäî ÏÇ¨Îûå: {selectedCard.name} ({selectedCard.phone})</p>
                </div>
                
                <div>
                  <Label>Î©îÏãúÏßÄ Ïú†Ìòï</Label>
                  <Select value={messageType} onValueChange={(value: 'custom' | 'template' | 'ai') => setMessageType(value)}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="custom">ÏßÅÏ†ë ÏûÖÎ†•</SelectItem>
                      <SelectItem value="template">ÌÖúÌîåÎ¶ø ÏÇ¨Ïö©</SelectItem>
                      <SelectItem value="ai">AI ÏûêÎèô ÏûëÏÑ±</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                {messageType === 'template' && (
                  <div>
                    <Label>ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù</Label>
                    <Select value={selectedTemplate} onValueChange={setSelectedTemplate}>
                      <SelectTrigger>
                        <SelectValue placeholder="ÌÖúÌîåÎ¶øÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî" />
                      </SelectTrigger>
                      <SelectContent>
                        {templates.map((template) => (
                          <SelectItem key={template.id} value={template.id}>
                            {template.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                )}

                {messageType === 'custom' && (
                  <div>
                    <Label htmlFor="sms-message">Î©îÏãúÏßÄ</Label>
                    <Textarea
                      id="sms-message"
                      value={smsMessage}
                      onChange={(e) => setSmsMessage(e.target.value)}
                      placeholder="Î∞úÏÜ°Ìï† Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                      rows={4}
                    />
                  </div>
                )}

                {messageType === 'ai' && (
                  <div className="text-sm text-gray-600 p-3 bg-gray-50 rounded">
                    <p>AIÍ∞Ä Î™ÖÌï® Ï†ïÎ≥¥ÏôÄ Ï∂îÍ∞Ä Î©îÎ™®Î•º Î∞îÌÉïÏúºÎ°ú ÏûêÎèôÏúºÎ°ú Î©îÏãúÏßÄÎ•º ÏûëÏÑ±Ìï©ÎãàÎã§.</p>
                  </div>
                )}

                {/* Î©îÏãúÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ */}
                {messagePreview && (
                  <div>
                    <Label>
                      <div className="flex items-center gap-2">
                        <Eye className="w-4 h-4" />
                        Î∞úÏÜ° ÏòàÏ†ï Î©îÏãúÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞
                      </div>
                    </Label>
                    <div className="border rounded-lg p-3 bg-gray-50 text-sm whitespace-pre-wrap">
                      {messagePreview}
                    </div>
                  </div>
                )}

                <Button
                  onClick={sendSMS}
                  disabled={isSending || (messageType === 'custom' && !smsMessage) || (messageType === 'template' && !selectedTemplate) || !messagePreview}
                  className="w-full"
                >
                  {isSending ? 'Î∞úÏÜ° Ï§ë...' : 'Î¨∏Ïûê Î∞úÏÜ°'}
                </Button>
              </div>
            </DialogContent>
          </Dialog>
        )}

        {/* ÏÑ§Ï†ï Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
        <SettingsDialog
          open={showSettingsDialog}
          onOpenChange={setShowSettingsDialog}
          templates={templates}
          onRefreshTemplates={fetchTemplates}
        />

        {/* ÌÖúÌîåÎ¶ø Í¥ÄÎ¶¨ Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
        <TemplateManagementDialog
          open={showTemplateDialog}
          onOpenChange={setShowTemplateDialog}
          templates={templates}
          onRefreshTemplates={fetchTemplates}
        />

        {/* ÏãúÏä§ÌÖú ÏßÑÎã® Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
        {debugInfo && (
          <Dialog open={showDebugInfo} onOpenChange={setShowDebugInfo}>
            <DialogContent className="max-w-2xl">
              <DialogHeader>
                <DialogTitle>ÏãúÏä§ÌÖú ÏßÑÎã® Í≤∞Í≥º</DialogTitle>
                <DialogDescription>
                  APIÏôÄ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï©ÎãàÎã§.
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4">
                <div className="bg-gray-50 p-4 rounded-lg">
                  <div className="flex items-center gap-2 mb-2">
                    <span className={`w-3 h-3 rounded-full ${debugInfo.status === 'healthy' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                    <span className="font-medium">
                      ÏÉÅÌÉú: {debugInfo.status === 'healthy' ? 'Ï†ïÏÉÅ' : 'Ïò§Î•ò'}
                    </span>
                  </div>
                  <div className="text-sm text-gray-600">
                    ÏãúÍ∞Ñ: {debugInfo.timestamp}
                  </div>
                </div>

                {debugInfo.database && (
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <h4 className="font-medium mb-2">üìä Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÉÅÌÉú</h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div>ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ: {debugInfo.database.userProfiles}Í∞ú</div>
                      <div>Î™ÖÌï®: {debugInfo.database.businessCards}Í∞ú</div>
                      <div>ÌÖúÌîåÎ¶ø: {debugInfo.database.templates}Í∞ú</div>
                      <div>ÏÑ§Ï†ï: {debugInfo.database.settings}Í∞ú</div>
                    </div>
                  </div>
                )}

                {debugInfo.environment && (
                  <div className="bg-purple-50 p-4 rounded-lg">
                    <h4 className="font-medium mb-2">üåê ÌôòÍ≤Ω Ï†ïÎ≥¥</h4>
                    <div className="text-sm space-y-1">
                      <div>ÌôòÍ≤Ω: {debugInfo.environment.nodeEnv}</div>
                      <div>Îü∞ÌÉÄÏûÑ: {debugInfo.environment.runtime}</div>
                      <div>ÏßÄÏó≠: {debugInfo.environment.region}</div>
                    </div>
                  </div>
                )}

                {debugInfo.error && (
                  <div className="bg-red-50 p-4 rounded-lg">
                    <h4 className="font-medium mb-2 text-red-700">‚ùå Ïò§Î•ò Ï†ïÎ≥¥</h4>
                    <div className="text-sm space-y-1">
                      <div><strong>ÌÉÄÏûÖ:</strong> {debugInfo.error.name}</div>
                      <div><strong>Î©îÏãúÏßÄ:</strong> {debugInfo.error.message}</div>
                      {debugInfo.error.stack && (
                        <div>
                          <strong>Ïä§ÌÉù:</strong>
                          <pre className="mt-1 text-xs bg-gray-100 p-2 rounded overflow-auto">
                            {debugInfo.error.stack}
                          </pre>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                <div className="flex gap-2">
                  <Button onClick={runHealthCheck} variant="outline" className="flex-1">
                    üîÑ Îã§Ïãú ÌôïÏù∏
                  </Button>
                  <Button onClick={() => setShowDebugInfo(false)} className="flex-1">
                    Îã´Í∏∞
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>
        )}
      </div>
    </div>
  )
}
